// Copyright 2015 The Vanadium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file.

var css = require('./components/base/index.css');
var debug = require('debug')('reader:main');
var document = require('global/document');
var domready = require('domready');
var files = require('./components/files');
var footer = require('./components/footer');
var format = require('format');
var h = require('mercury').h;
var header = require('./components/header');
var hg = require('mercury');
var insert = require('insert-css');
var mover = require('./components/mover');
var router = require('./components/router');
var window = require('global/window');
var error = require('./components/error');
var devices = require('./components/devices');

// Expose globals for debugging.
window.debug = require('debug');
window.require = require;
global.require = require;

domready(function ondomready() {
  debug('domready');

  // Top level state.
  var state = hg.state({
    store: hg.value(null),
    router: router.state({
      '#!/': index,
      '#!/mover': showMover,
      '#!/:id': show,
      '*': notfound
    }),
    files: files.state(),
    devices: devices.state()
    // device:



    // mover: mover.state({}),
  });

  // TODO(jasoncampbell): Can there be a dynamic error listener which maps
  // errors to the top error component?
  state.files.error(function (err) {
    console.error('err', err);
  });

  hg.app(document.body, state, render);
});

function render(state) {
  debug('render: %o', state);
  insert(css);

  return h('.reader-app', [
    hg.partial(header.render, state),
    hg.partial(router.render, state.router, state),
    hg.partial(footer.render, state, state.files.channels.add)
  ]);
}

function index(state, params, route) {
  debug('index route: %o', route);

  return h('main', [
    hg.partial(files.render, state.files, state.files.channels)
  ]);
}

function show(state, params, route) {
  debug('show: %s', params.id, state);

  return h('main', [

  ]);
}

function showMover(state, params, route) {
  debug('show mover');
  return h('main', [
    hg.partial(mover.render, state.mover, state.mover.channels),
  ]);
}

function notfound(state) {
  var href = state.router.href;
  console.error('TODO: not found error - %s', href);

  return h('.notfound', [
    h('Not Found.'),
    h('p', format('The page "%s" does not exisit.', state.router.href))
  ]);
}
